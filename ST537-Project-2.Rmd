---
title: "Final Project -- Second Draft"
author: "Kan Luo, Shih-Ni Prim"
date: "10/24/2020"
output: 
  pdf_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(ggplot2)
library(httr)
library(nlme)
library(emmeans)
```

# Questions/next steps  

* Questions for Kan:
    * Samples from different organs?
    * Differences among isotypes?
* Why are there 7 treatment groups now?
    * Treatment 1-3: different doses for 1st drug
    * Treatment 4-6: different doses for 2nd drug
    * Treatment 7: control
* Instead of looking at average of Binding, look at average of reactivity to see the percentage of reactive
* Variances can be very different in different cells
* summaries of data points: time points, treatment groups, response variables, etc. 

# Data Preparation

The resulting dataset from this section is called `Data2`, and one outlier will be removed in a later section, which results in a final dataset `Data3`. So `Data3` is used for analysis. [This section won't be in the final report.]  

```{r readin Data, echo = FALSE, message = FALSE, warning = FALSE}
#Readin data from Github url address
url1 <- 'https://github.com/luokan1227/537P1/raw/master/Data.xlsx'  # main data
url2 <- 'https://github.com/luokan1227/537P1/raw/master/MonkeyID.xlsx'  # Monkey ID
GET(url1, write_disk(tf1 <- tempfile(fileext = ".xlsx")))
GET(url2, write_disk(tf2 <- tempfile(fileext = ".xlsx")))
Rawdata <- read_excel(tf1)
MonkeyID <-  read_excel(tf2)
#Add Monkey ID to raw data
Rawdata <- inner_join(Rawdata, MonkeyID, by = "H_ID")
colnames(Rawdata)[2] <- "Time_Point"
#-----------------------
#Adjust or add variables
#-----------------------

# Final data set for all following analysis
Data <- Rawdata

# extract classifications of antibodies
HV_Extract <- substr(Data$H_V, 5, 5)
Data$HV_Extract <- HV_Extract

HD_Extract <- substr(Data$H_D, 5, 5)
Data$HD_Extract <- HD_Extract

HJ_Extract <- substr(Data$H_J, 5, 5)
Data$HJ_Extract <- HJ_Extract

LV_Ex <- substr(Data$L_V, 5, 6)
LV_Extract <- ifelse(str_detect(LV_Ex, "-"), substr(LV_Ex, 1, 1), substr(LV_Ex, 1, 2)) 
Data$LV_Extract <- LV_Extract

LJ_Extract <- substr(Data$L_J, 5, 5)
Data$LJ_Extract <- LJ_Extract

# add drug type 
Data$Drug <- ifelse(Data$Treatment == "group 7", 3, 
                      ifelse(Data$Treatment == "group 1", 1, 
                      ifelse(Data$Treatment == "group 2", 1, 
                      ifelse(Data$Treatment == "group 3", 1, 2))))

Data$Reactivity <- ifelse(Data$Binding > 0.1, 1, 0)

# create a subset with the variables we need plus the extracted information
Data2 <- Data %>% select(MonkeyID, Drug, Treatment, Time_Point, Isotype, HV_Extract, HD_Extract, HJ_Extract, H_VBase, H_Substitutions, H_Insertions, H_Deletions, HMuFreq, H_CDR3, LV_Extract, LJ_Extract, L_VBase, L_Substitutions, L_Insertions, L_Deletions, LMuFreq, L_CDR3, Binding, Reactivity)
```

# Abstract  

# Introduction  



# Methodologies  

# Data Summaries  

Our data came from a vaccine study, in which 20 rhesus marcaque was given HIV vaccines as well as immunosuppressing treatments that can inhibit human body's mechanism to suppress antibodies and, in theory, enhance the effect of vaccines. The dataset has `r nrow(Data2)` data points, 20 rhesus monkeys. 

```{r}
table(Data2$MonkeyID)
```

There are four time points; one before any procedure was done, and three after vaccine shots were administered to the macaques. In the treatment groups, groups 1-3 represent different doses of drug 1, groups 4-6 represent different doses of drug 2, and group 7 represents the control group. Later we'll look at the effect made by different drugs first and then different doses.  

```{r}
table(Data2$Time_Point, Data2$Treatment)
table(Data2$Drug, Data2$Treatment)
```

Now we look at the table of each marcaque and the corresponding treatment group. As the table shows, each marcaque only received one kidn of treatment.  
```{r}
table(Data2$MonkeyID, Data2$Treatment)
```


```{r}
ggplot(Data2, aes(x = Drug, y = Binding)) + geom_boxplot(aes(group = Drug))
```

```{r}
table(Data$Drug, Data$Reactivity)
table(Data$Time_Point, Data$Reactivity)
```


```{r}
Data2 %>% group_by(Drug) %>% summarize(avgLMuFreq = mean(LMuFreq), avgHMuFreq = mean(HMuFreq), avgBinding = mean(Binding), varBinding = var(Binding), avgReact = mean(Reactivity))
ggplot(Data2, aes(x = Drug, y = Binding)) + geom_point()
ggplot(Data2, aes(x = Treatment, y = Binding)) + geom_point()
```

```{r}
Data2 %>% select(LMuFreq, HMuFreq, L_CDR3, H_CDR3, Binding) %>% pairs()
```

## Outlier detection

Notice may have outlier in LCDR3 variable.

```{r outlier}
summary(Data2$L_CDR3)
subset1 <- Data2 %>% select(L_CDR3, H_CDR3)
subset1$d2 <- mahalanobis(subset1, colMeans(subset1), cov(subset1))
subset1$Z <- scale(subset1)
plot(subset1$d2)
plot(subset1$Z)
subset2 <- subset1 %>% arrange(desc(d2), desc(Z)) 
subset2[1,]
which(subset1$L_CDR3 == 47)
```
Row 972 from `Data2` is in fact an outlier, as shown in the summary and plots above. The value for `L_CDR3` is quite unlikely. Since we can't go back to the original data, we remove the data point and will use the new dataset `Data3`.  

```{r}
Data2[972,]
Data3 <- Data2[-972,]
```



# Multivariate Data Analysis  

```{r}
ID <- as.factor(Data3$MonkeyID)
trt <- as.factor(Data3$Treatment)
drug <- as.factor(Data3$Drug)
tp <- as.factor(Data3$Time_Point)
it <- as.factor(Data3$Isotype)
# four-way manova


fit.manova <- manova(cbind(Data3$L_CDR3, Data3$LMuFreq, Data3$H_CDR3, Data3$HMuFreq, Data3$Binding) ~ drug + tp)
summary(fit.manova)

fit.gls <- lm(cbind(Data3$L_CDR3, Data3$LMuFreq, Data3$H_CDR3, Data3$HMuFreq, Data3$Binding) ~ drug + tp)
summary(fit.gls)

fit.logit <- lm(Data3$Reactivity ~ drug*tp)
summary(fit.logit)
```
## Pairwise comparison

Now we take a look at the pairwise comparison for each treatment group.  

```{r}
respMat <- as.matrix(Data3[,c("L_CDR3", "LMuFreq", "H_CDR3", "HMuFreq", "Binding")])
# pairwise comparison among treatment groups
fit1 <- manova(respMat[,1:5] ~ trt)
# summary(fit1)

vars <- c("L_CDR3", "LMuFreq", "H_CDR3", "HMuFreq", "Binding")

p <- 5
q1 <- length(unique(trt))
alpha.old <- 0.05
nc1 <- p*q1*(q1-1)/2
alpha.new1 <- alpha.old/nc1

for (i in 1:5){
  w <- c(0, 0, 0, 0, 0)
  w[i] <- 1
  print(paste(vars[i], " pairwise CI's"))
  cont <- contrast(emmeans(fit1, "trt", weights = w), "pairwise")
  bb <- confint(cont, level = 1 - alpha.new1, adj = "none")
  print(bb)
}
```

```{r}
# pairwise comparison among drug groups
fit2 <- manova(respMat[,1:5] ~ drug)
# summary(fit2)
p <- 5
q2 <- length(unique(drug))
alpha.old <- 0.05
nc2 <- p*q2*(q2-1)/2
alpha.new2 <- alpha.old/nc2

for (i in 1:5){
  w <- c(0, 0, 0, 0, 0)
  w[i] <- 1
  print(paste(vars[i], " pairwise CI's"))
  cont <- contrast(emmeans(fit2, "drug", weights = w), "pairwise")
  bb <- confint(cont, level = 1 - alpha.new2, adj = "none")
  print(bb)
}
```

```{r}
# pairwise comparison among time point
fit3 <- manova(respMat[,1:5] ~ tp)
# summary(fit3)
p <- 5
q3 <- length(unique(tp))
alpha.old <- 0.05
nc3 <- p*q3*(q3-1)/2
alpha.new3 <- alpha.old/nc3

for (i in 1:5){
  w <- c(0, 0, 0, 0, 0)
  w[i] <- 1
  print(paste(vars[i], " pairwise CI's"))
  cont <- contrast(emmeans(fit3, "tp", weights = w), "pairwise")
  bb <- confint(cont, level = 1 - alpha.new3, adj = "none")
  print(bb)
}
```



# Longitudinal Data Analysis  

* check assumption of compound symmetry or equal variance  

First we don't consider treatments but only plot the mean trend over time.  

$$Y_{ij}=\beta_0+\beta_1 Time_{ij}+e_{ij}$$

```{r}
# simply connects the mean of each time point
ggplot(Data3, aes(x = Time_Point, y = Binding)) + geom_point(aes(color = as.factor(Drug))) + geom_jitter() + stat_summary(fun = mean, geom = "line", lwd = 3, color = "red")
```


Here we use Binding as the only response. 
Prdictors: `Drug`.  
Random effect for both intercept and slope.  

$$Y_{ij} = \beta_0+\beta_1 t_{ij} + b_{0i} + b_{1i} + e_{ij}$$

```{r}
lda <- lme(fixed = Binding ~ Time_Point + Drug,
           random = ~ Time_Point | MonkeyID, data = Data3, method = "REML")
summary(lda)
```


